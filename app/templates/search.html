{% extends "layout.html" %}

{% set field = request.args.get('sort')|default(None) %}
{% set direction = request.args.get('reversed')|int(default=1) %}

{% block content %}

{% if not auctions %}
<div class="container">
    <div class="jumbotron">
        <h4>Search</h4>
        <form method="POST" action="/">
            {{ form.hidden_tag() }}
            <div class="input-group">
                <input id="search" type="text" name="search" class="form-control" placeholder="Search">
                <span class="input-group-btn">
                    <button type="submit" class="btn btn-default">
                        <span class="glyphicon glyphicon-search" aria-hidden="true"></span>
                    </button>
                </span>
            </div>
        </form>
        {% if search_string %}
        <p>no results for <strong>{{ search_string }}</strong> found.</p>
        {% endif %}
    </div>
</div>
{% else %}

<div class="container">
    <div class="container" id="analytics">
        <h2>Results for <strong><i>{{ search_string }}</i></strong></h2>
        {% if stats['display'] %}
            <ul class="list-group">
                <li class="list-group-item">
                    Best Price Per Stick
                    <span class="badge">
                        {{ '%3.2f' % stats['best'] }}
                    </span>
                </li>
                <li class="list-group-item">
                    Great Price Per Stick
                    <span class="badge">
                        {{ '%3.2f' % stats['great'] }}
                    </span>
                </li>
                <li class="list-group-item">
                    Good Price Per Stick
                    <span class="badge">
                        {{ '%3.2f' % stats['good'] }}
                    </span>
                </li>
                <li class="list-group-item">
                    Average Price Per Stick
                    <span class="badge">
                        {{ '%3.2f' % stats['avg'] }}
                    </span>
                </li>
                <li class="list-group-item">
                    Poor Price Per Stick
                    <span class="badge">
                        {{ '%3.2f' % stats['poor'] }}
                    </span>
                </li>
                <li class="list-group-item">
                    Bad Price Per Stick
                    <span class="badge">
                        {{ '%3.2f' % stats['bad'] }}
                    </span>
                </li>
                <li class="list-group-item">
                    Worst Price Per Stick
                    <span class="badge">
                        {{ '%3.2f' % stats['worst'] }}
                    </span>
                </li>
                <li class="list-group-item">
                    Standard Deviation
                    <span class="badge">
                        {{ '%3.2f' % stats['std_deviation'] }}
                    </span>
                </li>
            </ul>
        {% endif %}
    </div>
    <div class="container" id="trends">
        <div class="container" id="heatmap-placeholder" style="height:100px;"></div>
        <div class="container" id="trend-placeholder" style="height:200px"></div>
    </div>

    <div class="container" id="current-auctions" style="display: none;">
        <table class="table table-striped">
            <thead>
                <td>Title</td><td>Category</td><td></td><td>Time Left</td>
            </thead>
            <tbody>
                {% for item in auctions %}{% if not item.finished %}
                <tr>
                    <td>
                        {{ item.name}}
                        <span class="pull-right">
                            <a class="btn btn-info btn-xs" href="{{ item.link }}">
                                <span class="glyphicon glyphicon-new-window" aria-hidden="true"></span>
                            </a>
                        </span>
                    </td>
                    <td>
                        {{ item.type }}
                        {% if item.type and 'pack' not in item.type and 'single' not in item.type and 'sample' not in item.type %}
                        <small>
                            /{{ item.quantity }}
                        </small>
                        {% endif %}
                    </td>
                    <td><img src="{{ url_for('.static', filename='images/logos/%s.png' % item.site) }}" /></td>
                    <td>{{ '%sd %sh %sm' % item.time_left }}</td>
                </tr>
                {% endif %}{% endfor %}
            </tbody>
        </table>
    </div>

    <div class="container">
        <div class="row">
            <button class="btn btn-primary btn-sm" onclick="toggle_visibility('current-auctions');">Open Auctions</button>
            <a class="btn btn-sm btn-{% if direction %}success{% else %}primary{% endif %}" href="{{ url_for('search', search_string=search_string, reversed=(not direction)|int, sort=field) }}">Reversed</a>
             <div class="btn-group">
            <button type="button" class="btn btn-primary btn-sm dropdown-toggle" data-toggle="dropdown-menu" aria-haspop="true" aria-expanded="false">
                Sort <span class="caret"></span>
            </button>
            <ul class="dropdown-menu">
                <li><a href="{{ url_for('search', search_string=search_string, reversed=direction, sort='name') }}">Auction Name</a></li>
                <li><a href="{{ url_for('search', search_string=search_string, reversed=direction, sort='price_per_stick') }}">Price Per Stick</a></li>
                <li><a href="{{ url_for('search', search_string=search_string, reversed=direction, sort='price') }}">Auction Price</a></li>
            </ul>
            </div>
        </div>
    </div>
    <div class="container" id="history">
        <table class="table table-striped">
            <thead>
                <td>Title</td><td>Category</td><td>Closed</td><td></td><td>Price</td>
            </thead>
            <tbody>
                {% for item in auctions|sort(attribute=field, reverse=direction) %}{% if item.price and item.finished %}
                <tr>
                    <td>
                        {{ item.name}}
                        <span class="pull-right">
                            <a class="btn btn-info btn-xs" href="{{ item.link }}">
                                <span class="glyphicon glyphicon-new-window" aria-hidden="true"></span>
                            </a>
                        </span>
                    </td>
                    <td>
                        {{ item.type }}
                        {% if item.type != None and 'pack' not in item.type and 'single' not in item.type and 'sample' not in item.type %}
                        <small>
                            /{{ item.quantity }}
                        </small>
                        {% endif %}
                    </td>
                    <td>{{ item.close.strftime('%Y-%m-%d') }}</td>
                    <td><img src="{{ url_for('.static', filename='images/logos/%s.png' % item.site) }}" /></td>
                    <td>
                        <big>
                            {{ '%3.2f' % item.price_per_stick if item.price_per_stick else 'N/A'}}
                        </big>
                        <span class="text-muted">
                            <small>
                                /{{ '%3.2f' % item.price if item.price else 'N/A'}}
                            </small>
                        </span>
                    </td>
                </tr>
                {% endif %}{% endfor %}
            </tbody>
        </table>
    </div>
</div>
{% endif %}
{% endblock %}

{% block scripts %}
{{ super() }}
<script type="text/javascript">
    (function($) {
        $(function() {
            var trend = {
                color: 'rgba(44, 62, 80, 1)',
                data: {{ stats['trend'] }}
            };
            var heat = {
                color: 'rgba(0, 0, 0, 1)',
                data: {{ stats['heatmap'] }},
                bars: {
                    show: true,
                    barWidth: .1,
                },
            };
            $.plot($("#trend-placeholder"), [trend], {
                xaxis: { mode: "time" },
                series: {lines: {
                    fill: true,
                    fillColor: "rgba(44, 62, 80, 0.6)"
                }},
            });
            $.plot($("#heatmap-placeholder"), [heat], {
                yaxis: {show: false},
                xaxis: {tickDecimals: 2},
                grid: {
                    markings: [
                        {xaxis: {from: {{ stats['great'] }}, to: {{ stats['good'] }}}, color: "#357abd"},
                        {xaxis: {from: {{ stats['good'] }}, to: {{ stats['avg'] }}}, color: "#4cae4c"},
                        {xaxis: {from: {{ stats['avg'] }}, to: {{ stats['poor'] }}}, color: "#fdc431"},
                        {xaxis: {from: {{ stats['poor'] }}, to: {{ stats['bad'] }}}, color: "#ee9336"},
                    ],
                    hoverable: true,
                    autoHighlight: true,
                }
            });
        });
    })(jQuery);
</script>
{% endblock %}